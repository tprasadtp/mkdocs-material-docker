name: build
on:
  push:
    paths-ignore:
      - ".gitignore"
      - ".envrc"
      - "**.md"
      - ".vscode/**"
      - ".dependabot/**"
      - "_config.yml"
  pull_request:
jobs:
  # Lint
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Lint Dockerfiles
        run: |
          make docker-lint
  # Build Docker Images
  docker:
    env:
      DOCKER_CLI_EXPERIMENTAL: enabled
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Download BuildX
        run: |
          curl -sSfL https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64 -o buildx
          mkdir -p ${HOME}/.docker
          cp buildx ${HOME}/.docker/buildx
          chmod +x ${HOME}/.docker/buildx
      - name: Install binfmt
        run: |
          sudo docker run --rm --privileged docker/binfmt:a7996909642ee92942dcd6cff44b9b95f08dad64
          cat /proc/sys/fs/binfmt_misc/qemu-aarch64
      - name: Create Builder
        run: |
          docker buildx create --name actions
          docker buildx use actions
          docker buildx inspect --bootstrap
          docker buildx version
      - name: Build Docker
        run: |
          make debug-vars
          make docker

      - name: Docker Login to Registry (DockerHub)
        run: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        env:
          DOCKER_USERNAME: tprasadtp
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        if: github.event_name == 'push'

      - name: Docker Login to Registry (GitHub)
        run: echo "$DOCKER_PASSWORD" | docker login docker.pkg.github.com -u "$DOCKER_USERNAME" --password-stdin
        env:
          DOCKER_USERNAME: tprasadtp
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        if: github.event_name == 'push'

      - name: Docker Push
        run: make docker-push
        if: github.event_name == 'push'

      - name: Docker Cleanup
        run: docker logout && rm -f ${HOME}/.docker/config.json
        if: github.event_name == 'push'
